apiVersion: batch/v1
kind: CronJob
metadata:
  name: holdwall-backup
  namespace: holdwall
spec:
  schedule: "0 2 * * *" # Daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: holdwall-worker
          containers:
            - name: backup
              image: 597743362576.dkr.ecr.us-east-1.amazonaws.com/holdwall-pos:20260124-221959
              workingDir: /app
              command:
                [
                  "sh",
                  "-lc",
                  "npx tsx -e \"const { backupService } = require('./lib/backup/disaster-recovery'); backupService.createBackup(undefined,{ storageProvider:'s3', compression:true, encryption:true }).then(r=>{ console.log(JSON.stringify(r)); process.exit(r.status==='success'?0:1); }).catch(e=>{ console.error(e); process.exit(1); });\"",
                ]
              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: DATABASE_URL
                - name: S3_BACKUP_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: S3_BACKUP_BUCKET
                - name: BACKUP_ENCRYPTION_KEY
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: BACKUP_ENCRYPTION_KEY
                - name: AWS_REGION
                  value: "us-east-1"
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: holdwall-kafka-lag-check
  namespace: holdwall
spec:
  schedule: "*/5 * * * *" # Every 5 minutes
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: holdwall-worker
          containers:
            - name: kafka-lag-check
              image: 597743362576.dkr.ecr.us-east-1.amazonaws.com/holdwall-pos:20260124-221959
              workingDir: /app
              command:
                [
                  "sh",
                  "-lc",
                  "node -e \"const {Kafka}=require('kafkajs'); const {SNSClient,PublishCommand}=require('@aws-sdk/client-sns'); const brokers=(process.env.KAFKA_BROKERS||'').split(',').map(s=>s.trim()).filter(Boolean); const eventsTopic=(process.env.KAFKA_EVENTS_TOPIC||'holdwall-events').trim(); const groupId=(process.env.KAFKA_GROUP_ID||'holdwall-pipeline-worker').trim(); const warn=parseInt(process.env.KAFKA_LAG_WARN_THRESHOLD||'1000',10); const snsArn=(process.env.SNS_TOPIC_ARN||'').trim(); const tls=process.env.KAFKA_SSL==='true'||process.env.KAFKA_TLS==='true'||brokers.some(b=>String(b).includes(':9094')); const kafka=new Kafka({clientId:'holdwall-kafka-lag-check',brokers,ssl: tls?{rejectUnauthorized:true}:undefined}); (async()=>{ if(!brokers.length){ console.log(JSON.stringify({status:'skipped',reason:'no_brokers'})); return; } const admin=kafka.admin(); await admin.connect(); const latest=await admin.fetchTopicOffsets(eventsTopic); const group=await admin.fetchOffsets({groupId,topics:[eventsTopic]}); const latestBy=new Map(latest.map(p=>[p.partition,parseInt(p.offset,10)||0])); let totalLag=0; const partitions=[]; for(const t of group){ for(const p of t.partitions){ const committed=parseInt(p.offset,10); const l=latestBy.get(p.partition)||0; const lag = committed>=0 ? Math.max(0,l-committed) : l; totalLag+=lag; partitions.push({partition:p.partition,committed,latest:l,lag}); } } const report={status: totalLag>warn ? 'warning':'pass', totalLag, warn, topic: eventsTopic, groupId, partitions}; console.log(JSON.stringify(report,null,2)); if(snsArn && totalLag>warn){ const sns=new SNSClient({region:process.env.AWS_REGION||'us-east-1'}); await sns.send(new PublishCommand({TopicArn:snsArn,Subject:'Holdwall Kafka lag warning',Message:JSON.stringify(report,null,2)})); } await admin.disconnect(); })().catch(async(e)=>{ console.error(e); if(snsArn){ try{ const sns=new SNSClient({region:process.env.AWS_REGION||'us-east-1'}); await sns.send(new PublishCommand({TopicArn:snsArn,Subject:'Holdwall Kafka lag check failed',Message:String(e&&e.stack||e)})); }catch{} } process.exit(1); });\"",
                ]
              env:
                - name: SNS_TOPIC_ARN
                  value: "arn:aws:sns:us-east-1:597743362576:holdwall-ops-alerts"
                - name: KAFKA_BROKERS
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: KAFKA_BROKERS
                - name: KAFKA_LAG_WARN_THRESHOLD
                  value: "1000"
              envFrom:
                - configMapRef:
                    name: holdwall-config
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: holdwall-reindex
  namespace: holdwall
spec:
  schedule: "0 */6 * * *" # Every 6 hours
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: holdwall-worker
          containers:
            - name: reindex
              image: 597743362576.dkr.ecr.us-east-1.amazonaws.com/holdwall-pos:20260124-221959
              workingDir: /app
              command: ["node", "-e", "require('./lib/evidence/reindex').reindexLegacyEvidence()"]
              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: DATABASE_URL
                - name: CHROMA_URL
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: CHROMA_URL
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "1Gi"
                  cpu: "1000m"
          restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: holdwall-pos-cycle
  namespace: holdwall
spec:
  schedule: "0 */6 * * *" # Every 6 hours
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: holdwall-worker
          containers:
            - name: pos-cycle
              image: 597743362576.dkr.ecr.us-east-1.amazonaws.com/holdwall-pos:20260124-221959
              workingDir: /app
              command: ["node", "-e", "require('./lib/pos/cycle-worker').executePOSCycleForAllTenants()"]
              env:
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: holdwall-secrets
                      key: DATABASE_URL
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "1Gi"
                  cpu: "1000m"
          restartPolicy: OnFailure
